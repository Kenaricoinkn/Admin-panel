<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KenariCoin Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

  <!-- Login Page -->
  <section id="loginPage" class="h-screen flex items-center justify-center">
    <div class="bg-gray-800 p-8 rounded-xl shadow w-96">
      <h2 class="text-2xl font-bold text-yellow-400 mb-6 text-center">Admin Login</h2>
      <input type="text" id="adminUser" placeholder="Username" 
             class="w-full p-3 mb-4 rounded bg-gray-700 text-white"/>
      <input type="password" id="adminPass" placeholder="Password" 
             class="w-full p-3 mb-4 rounded bg-gray-700 text-white"/>
      <button onclick="doLogin()" 
              class="w-full py-3 bg-yellow-500 text-black font-bold rounded hover:bg-yellow-400">
        Login
      </button>
      <p id="loginError" class="text-red-400 mt-3 hidden">‚ùå Username atau Password salah</p>
    </div>
  </section>

  <!-- Admin Panel -->
  <section id="adminPanel" class="hidden p-6">
    <h2 class="text-3xl font-bold text-yellow-400 mb-6">üìä KenariCoin Admin Panel</h2>

   <!-- Leaderboard -->
<div class="mb-8">
  <h3 class="text-xl font-semibold mb-3">üèÜ Leaderboard Staker</h3>

  <!-- Filter & Sort Controls -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
    <input id="searchAdmin" type="text" placeholder="üîç Cari wallet..."
           class="p-2 rounded bg-gray-700 text-white border border-gray-600 w-full md:w-1/2"
           oninput="renderAdminLeaderboard()" />

    <select id="sortAdmin" onchange="renderAdminLeaderboard()"
            class="p-2 rounded bg-gray-700 text-yellow-400 border border-gray-600">
      <option value="rank">Sort by Rank</option>
      <option value="amount">Sort by Staked</option>
    </select>
  </div>

  <table class="w-full text-left border border-gray-700 rounded overflow-hidden">
    <thead class="bg-gray-800 text-yellow-400">
      <tr><th class="p-2">Rank</th><th class="p-2">Wallet</th><th class="p-2">Staked KN</th></tr>
    </thead>
    <tbody id="adminLeaderboard" class="bg-gray-900 text-gray-300">
      <tr><td colspan="3" class="p-3 text-center">‚ü≥ Loading...</td></tr>
    </tbody>
  </table>

  <button onclick="exportCSV()" 
          class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-400">
    ‚¨áÔ∏è Export CSV
  </button>
</div>

    <!-- Bonus -->
    <div class="mb-8">
      <h3 class="text-xl font-semibold mb-3">üéÅ Bonus Reward</h3>
      <input type="text" id="bonusAddress" placeholder="Wallet Address" 
             class="w-full p-3 mb-3 rounded bg-gray-700 text-white"/>
      <input type="number" id="bonusAmount" placeholder="Jumlah KN" 
             class="w-full p-3 mb-3 rounded bg-gray-700 text-white"/>
      <button onclick="giveBonus()" 
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-400">
        ‚úÖ Kirim Bonus
      </button>
      <p id="bonusStatus" class="mt-2"></p>
    </div>

    <!-- Log -->
    <div>
      <h3 class="text-xl font-semibold mb-3">üìù Log Aktivitas</h3>
      <ul id="logList" class="list-disc pl-5 text-gray-300"></ul>
    </div>
  </section>

  <script>
    // ======================
    // Konfigurasi Admin
    // ======================
    const ADMIN_USER = "dev";
    const ADMIN_PASS = "kenari123";
    const STAKING_CONTRACT = "0xYourStakingContract"; // ganti dgn kontrak
    const KN = "0xYourTokenContract"; // ganti dgn kontrak token
    let provider, signer;

    // ======================
    // Login
    // ======================
    function doLogin(){
      const u = document.getElementById("adminUser").value;
      const p = document.getElementById("adminPass").value;
      if(u === ADMIN_USER && p === ADMIN_PASS){
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("adminPanel").classList.remove("hidden");
        log("‚úÖ Admin login sukses");
        loadLeaderboard();
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    // ======================
    // Leaderboard
    // ======================
    let adminStakerData = [];
let refreshInterval;

async function loadLeaderboard(){
  const tbody = document.getElementById("adminLeaderboard");
  tbody.innerHTML = `<tr><td colspan="3" class="p-3 text-center">‚ü≥ Loading...</td></tr>`;

  const contract = new ethers.Contract(
    STAKING_CONTRACT,
    [
      "function getAllStakers() view returns (address[])",
      "function getStaked(address user) view returns (uint256)"
    ],
    provider || new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org")
  );

  try {
    const stakers = await contract.getAllStakers();
    adminStakerData = [];
    for (let addr of stakers) {
      const amount = await contract.getStaked(addr);
      adminStakerData.push({ addr, amount: parseFloat(ethers.utils.formatUnits(amount, 18)) });
    }

    // Default sort by amount (desc)
    adminStakerData.sort((a, b) => b.amount - a.amount);

    renderAdminLeaderboard();
    log("üìä Leaderboard dimuat");
  } catch(err){
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="3" class="p-3 text-center text-red-400">‚ùå Gagal load</td></tr>`;
  }
}

function renderAdminLeaderboard(){
  const tbody = document.getElementById("adminLeaderboard");
  if (!tbody) return;

  let data = [...adminStakerData];

  // Filter
  const search = document.getElementById("searchAdmin")?.value.trim().toLowerCase();
  if (search) {
    data = data.filter(item => item.addr.toLowerCase().includes(search));
  }

  // Sort
  const sort = document.getElementById("sortAdmin")?.value;
  if (sort === "amount") {
    data.sort((a, b) => b.amount - a.amount);
  }

  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3" class="p-3 text-center text-red-400">‚ö†Ô∏è Tidak ada data</td></tr>`;
    return;
  }

  data.forEach((item, i) => {
    tbody.innerHTML += `
      <tr>
        <td class="p-2">${i+1}</td>
        <td class="p-2">${item.addr.slice(0,6)}...${item.addr.slice(-4)}</td>
        <td class="p-2">${item.amount} KN</td>
      </tr>`;
  });
}

// ======================
// Login
// ======================
function doLogin(){
  const u = document.getElementById("adminUser").value;
  const p = document.getElementById("adminPass").value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    log("‚úÖ Admin login sukses");

    // Load pertama kali
    loadLeaderboard();

    // Auto refresh tiap 1 menit
    clearInterval(refreshInterval);
    refreshInterval = setInterval(loadLeaderboard, 60 * 1000);

  } else {
    document.getElementById("loginError").classList.remove("hidden");
  }
}

    // ======================
    // Bonus Reward
    // ======================
    async function giveBonus(){
      try {
        if(!window.ethereum){
          alert("Hubungkan MetaMask untuk kirim bonus");
          return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();

        const token = new ethers.Contract(
          KN,
          [
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)"
          ],
          signer
        );

        const addr = document.getElementById("bonusAddress").value;
        const amount = document.getElementById("bonusAmount").value;
        const decimals = await token.decimals();
        const parsed = ethers.utils.parseUnits(amount.toString(), decimals);

        const tx = await token.transfer(addr, parsed);
        await tx.wait();

        document.getElementById("bonusStatus").innerText = `‚úÖ Bonus terkirim ke ${addr}`;
        log(`üéÅ Bonus ${amount} KN dikirim ke ${addr}`);
      } catch(err){
        console.error(err);
        document.getElementById("bonusStatus").innerText = "‚ùå Gagal kirim bonus";
      }
    }

    // ======================
    // Export CSV
    // ======================
    function exportCSV(){
      let rows = [["Rank","Wallet","Staked KN"]];
      const trs = document.querySelectorAll("#adminLeaderboard tr");
      trs.forEach(tr => {
        let cols = [...tr.querySelectorAll("td")].map(td => td.innerText);
        if(cols.length) rows.push(cols);
      });
      let csv = rows.map(r => r.join(",")).join("\n");
      let blob = new Blob([csv], { type: "text/csv" });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "leaderboard.csv";
      link.click();
      log("‚¨áÔ∏è Export CSV");
    }

    // ======================
    // Log
    // ======================
    function log(msg){
      const li = document.createElement("li");
      li.innerText = new Date().toLocaleTimeString()+" - "+msg;
      document.getElementById("logList").appendChild(li);
    }
  </script>

</body>
</html>